<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω–∫–∞ –ø–æ—Ä—Ç–æ–≤–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 20px; }
        .container { max-width: 1200px; }
        #sql-query-result, #stats-result { max-height: 400px; overflow-y: auto; }
        .spinner-border { display: none; }
        .error-msg { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>üö¢ –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –ø–∞–Ω–µ–ª—å –ø–æ—Ä—Ç–æ–≤–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞</h1>
            <a href="/logout" class="btn btn-outline-danger">–í—ã—Ö–æ–¥</a>
        </div>

        <!-- –°–µ–∫—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∞–±–ª–∏—Ü–∞–º –ë–î</h5>
            </div>
            <div class="card-body">
                <button id="load-stats-btn" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
                <div class="spinner-border spinner-border-sm ms-2" role="status" id="stats-spinner"></div>
                <div id="stats-result" class="mt-3"></div>
                <div id="stats-error" class="error-msg mt-2"></div>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ —Å –ø–æ–º–æ—â—å—é LLM</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="model-select" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å LLM:</label>
                    <select class="form-select" id="model-select">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="user-query" class="form-label">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∑–∞–ø—Ä–æ—Å –Ω–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —è–∑—ã–∫–µ:</label>
                    <textarea class="form-control" id="user-query" rows="3" placeholder="–ü—Ä–∏–º–µ—Ä: '–ü–æ–∫–∞–∂–∏ 5 —Å–∞–º—ã—Ö —Ç—è–∂–µ–ª—ã—Ö –≥—Ä—É–∑–æ–≤, –ø—Ä–∏–Ω—è—Ç—ã—Ö –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ'"></textarea>
                </div>
                <div class="mb-3">
                    <label for="query-examples" class="form-label">–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–º–µ—Ä:</label>
                    <select class="form-select" id="query-examples">
                        <option selected>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞...</option>
                    </select>
                </div>
                <button id="generate-sql-btn" class="btn btn-success">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å SQL</button>
                <div class="spinner-border spinner-border-sm ms-2" role="status" id="generate-spinner"></div>
                
                <div class="mt-3">
                    <label for="sql-query" class="form-label">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π SQL-–∑–∞–ø—Ä–æ—Å:</label>
                    <textarea class="form-control" id="sql-query" rows="4"></textarea>
                    <small class="form-text text-muted">–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º</small>
                    <div id="generate-error" class="error-msg mt-2"></div>
                </div>

                <div class="mt-3">
                    <label for="llm-prompt" class="form-label">–¢–æ—á–Ω—ã–π –ø—Ä–æ–º–ø—Ç, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –≤ LLM:</label>
                    <textarea class="form-control" id="llm-prompt" rows="8" readonly style="font-size: 12px; background-color: #f8f9fa;"></textarea>
                </div>

                <button id="execute-sql-btn" class="btn btn-info mt-2" disabled>–í—ã–ø–æ–ª–Ω–∏—Ç—å SQL</button>
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="create-chart-checkbox">
                    <label class="form-check-label" for="create-chart-checkbox">
                        –°–æ–∑–¥–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ (–µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—è—Ç)
                    </label>
                </div>
                <div class="spinner-border spinner-border-sm ms-2" role="status" id="execute-spinner"></div>
                
                <h6 class="mt-4">–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</h6>
                <div id="chart-container" class="mt-3" style="display: none;">
                    <h6>–ì—Ä–∞—Ñ–∏–∫:</h6>
                    <img id="chart-image" class="img-fluid border" alt="–ì—Ä–∞—Ñ–∏–∫ –¥–∞–Ω–Ω—ã—Ö" style="max-width: 100%; height: auto;">
                </div>
                <div id="sql-query-result" class="border p-2 bg-light"></div>
                <div id="execute-error" class="error-msg mt-2"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–æ–∫
        function showError(elementId, message) {
            const errorEl = $(`#${elementId}`);
            errorEl.text(message);
            errorEl.show();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –≤–∏–¥–µ —Ç–∞–±–ª–∏—Ü—ã
        function renderTable(elementId, data) {
            const container = $(`#${elementId}`);
            container.empty();
            if (data.length === 0) {
                container.text("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.");
                return;
            }
            const table = $('<table class="table table-bordered table-striped"></table>');
            const thead = $('<thead><tr></tr></thead>');
            const tbody = $('<tbody></tbody>');

            // –ó–∞–≥–æ–ª–æ–≤–∫–∏
            Object.keys(data[0]).forEach(key => {
                thead.find('tr').append(`<th>${key}</th>`);
            });

            // –°—Ç—Ä–æ–∫–∏
            data.forEach(row => {
                const tr = $('<tr></tr>');
                Object.values(row).forEach(val => {
                    tr.append(`<td>${val}</td>`);
                });
                tbody.append(tr);
            });

            table.append(thead).append(tbody);
            container.append(table);
        }

        $(document).ready(function() {
            let queryExamples = [];
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–º–µ—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–∑ JSON —Ñ–∞–π–ª–∞
            function loadQueryExamples() {
                $.ajax({
                    url: '/static/query_examples.json',
                    method: 'GET',
                    success: function(data) {
                        queryExamples = data.examples;
                        populateExampleSelect();
                    },
                    error: function(jqXHR) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–º–µ—Ä–æ–≤:', jqXHR);
                        // Fallback –∫ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º –ø—Ä–∏–º–µ—Ä–∞–º
                        queryExamples = [
                        ];
                        populateExampleSelect();
                    }
                });
            }
            
            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏–º–µ—Ä–∞–º–∏
            function populateExampleSelect() {
                const exampleSelect = $('#query-examples');
                exampleSelect.empty();
                exampleSelect.append('<option selected>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞...</option>');
                
                queryExamples.forEach(function(example) {
                    const option = $('<option></option>');
                    option.val(example.user_query);
                    option.text(example.user_query);
                    exampleSelect.append(option);
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –ø—Ä–∏–º–µ—Ä–∞
            $('#query-examples').on('change', function() {
                const selectedExample = $(this).val();
                if (selectedExample && selectedExample !== '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞...') {
                    $('#user-query').val(selectedExample);
                }
            });
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
            function loadModels() {
                $.ajax({
                    url: '/api/models',
                    method: 'GET',
                    success: function(data) {
                        const modelSelect = $('#model-select');
                        modelSelect.empty();
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏
                        data.models.forEach(function(model) {
                            const option = $('<option></option>');
                            option.val(model);
                            option.text(model);
                            if (model === data.current_model) {
                                option.attr('selected', true);
                            }
                            modelSelect.append(option);
                        });
                    },
                    error: function(jqXHR) {
                        $('#model-select').html('<option>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π</option>');
                    }
                });
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª–∏ –∏ –ø—Ä–∏–º–µ—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            loadModels();
            loadQueryExamples();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–¥–µ–ª–∏
            $('#model-select').on('change', function() {
                const selectedModel = $(this).val();
                if (selectedModel) {
                    $.ajax({
                        url: '/api/models/set',
                        method: 'POST',
                        data: JSON.stringify({model_name: selectedModel}),
                        contentType: 'application/json',
                        success: function(data) {
                            console.log('–ú–æ–¥–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞:', selectedModel);
                        },
                        error: function(jqXHR) {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –º–æ–¥–µ–ª–∏:', jqXHR.responseJSON?.error);
                        }
                    });
                }
            });
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            $('#load-stats-btn').on('click', function() {
                $('#stats-spinner').show();
                $('#stats-error').hide();
                $('#stats-result').empty();

                $.ajax({
                    url: '/api/stats',
                    method: 'GET',
                    success: function(data) {
                        if (data.error) {
                            showError('stats-error', `–û—à–∏–±–∫–∞: ${data.error}`);
                        } else {
                            renderTable('stats-result', data);
                        }
                    },
                    error: function(jqXHR) {
                        showError('stats-error', `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${jqXHR.responseJSON?.error || jqXHR.statusText}`);
                    },
                    complete: function() {
                        $('#stats-spinner').hide();
                    }
                });
            });

            // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã (–±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞)
            // let cachedSchema = null;

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ö–µ–º—ã —Å —Å–µ—Ä–≤–µ—Ä–∞ (–±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞)
            // function getSchemaFromServer() {
            //     // –£–¥–∞–ª–µ–Ω–æ, —Ç–∞–∫ –∫–∞–∫ —Å—Ö–µ–º–∞ —Ç–µ–ø–µ—Ä—å –≤ –ø—Ä–æ–º–ø—Ç–µ
            // }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ (–±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞ - –ø—Ä–æ–º–ø—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
            // function buildFullPrompt(userQuery, schemaInfo) {
            //     // –£–¥–∞–ª–µ–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –ø—Ä–æ–º–ø—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏–∑ llm_prompt_template.txt
            // }

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL
            $('#generate-sql-btn').on('click', function() {
                const userQuery = $('#user-query').val();
                if (!userQuery) {
                    showError('generate-error', '–ü–æ–ª–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.');
                    return;
                }

                $('#generate-spinner').show();
                $('#generate-error').hide();
                $('#sql-query').val('');
                $('#llm-prompt').val('');
                $('#execute-sql-btn').prop('disabled', true);

                $.ajax({
                    url: '/api/generate-sql-with-prompt',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ query: userQuery }),
                    success: function(data) {
                        console.log('–û—Ç–≤–µ—Ç –æ—Ç API:', data);
                        if (data.error) {
                            showError('generate-error', `–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${data.error}`);
                        } else {
                            console.log('–ü–æ–ª—É—á–µ–Ω–Ω—ã–π SQL:', data.sql_query);
                            $('#sql-query').val(data.sql_query);
                            $('#llm-prompt').val(data.full_prompt);
                            $('#execute-sql-btn').prop('disabled', false);
                        }
                    },
                    error: function(jqXHR) {
                        console.error('–û—à–∏–±–∫–∞ AJAX:', jqXHR);
                        showError('generate-error', `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${jqXHR.responseJSON?.error || jqXHR.statusText}`);
                    },
                    complete: function() {
                        $('#generate-spinner').hide();
                    }
                });
            });

            // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL
            $('#execute-sql-btn').on('click', function() {
                const sqlQuery = $('#sql-query').val();
                const userQuery = $('#user-query').val();
                const createChart = $('#create-chart-checkbox').is(':checked');
                
                if (!sqlQuery) {
                    showError('execute-error', '–ù–µ—Ç SQL-–∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.');
                    return;
                }

                $('#execute-spinner').show();
                $('#execute-error').hide();
                $('#sql-query-result').empty();
                $('#chart-container').hide();

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–æ–π API –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
                const apiUrl = createChart ? '/api/execute-sql-with-chart' : '/api/execute-sql';
                const requestData = createChart 
                    ? { query: sqlQuery, user_query: userQuery, create_chart: true }
                    : { query: sqlQuery };

                $.ajax({
                    url: apiUrl,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(requestData),
                    success: function(response) {
                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
                        if (response.error) {
                            showError('execute-error', `–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${response.error}`);
                            return;
                        }
                        
                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                        const data = response.data || response;
                        if (Array.isArray(data)) {
                            renderTable('sql-query-result', data);
                        } else {
                            $('#sql-query-result').text(JSON.stringify(data, null, 2));
                        }
                        
                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞
                        if (response.chart) {
                            $('#chart-image').attr('src', 'data:image/png;base64,' + response.chart);
                            $('#chart-container').show();
                        }
                    },
                    error: function(jqXHR) {
                        showError('execute-error', `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${jqXHR.responseJSON?.error || jqXHR.statusText}`);
                    },
                    complete: function() {
                        $('#execute-spinner').hide();
                    }
                });
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –ø—Ä–∏–º–µ—Ä–∞–º
            $('.query-example').on('click', function(e) {
                e.preventDefault(); // –û—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏
                const exampleText = $(this).text();
                $('#user-query').val(exampleText);
            });
        });
    </script>
</body>
</html>
