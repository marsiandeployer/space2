{% extends "admin/base.html" %}

{% block title %}SEO-—Å—Ç—Ä–∞–Ω–∏—Ü—ã - B2B SEO-Platform Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h2>SEO-—Å—Ç—Ä–∞–Ω–∏—Ü—ã</h2>
    <div class="breadcrumb">
        <a href="/admin">–î–∞—à–±–æ—Ä–¥</a> / SEO-—Å—Ç—Ä–∞–Ω–∏—Ü—ã
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
<div class="card">
    <h3>üîç –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã</h3>
    <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: end;">
        <div class="form-group" style="margin-bottom: 0;">
            <label for="searchInput">–ü–æ–∏—Å–∫ –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º:</label>
            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É, —Å–ª–∞–≥—É –∏–ª–∏ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º...">
        </div>
        <div style="white-space: nowrap;">
            <a href="/admin/create-page" class="btn btn-primary">‚ûï –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</a>
            <button class="btn btn-warning" onclick="refreshPages()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü -->
<div class="card">
    <h3>üìÑ –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü (<span id="pagesCount">0</span>)</h3>
    
    <div class="loading" id="pagesLoading">
        <div class="spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü...</div>
    </div>
    
    <div id="pagesContainer">
        <!-- –°—Ç—Ä–∞–Ω–∏—Ü—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class SeoPagesList {
    constructor() {
        this.pages = [];
        this.filteredPages = [];
        this.init();
    }

    async init() {
        await this.loadPages();
        this.setupEventListeners();
    }

    setupEventListeners() {
        document.getElementById('searchInput').addEventListener('input', (e) => {
            this.filterPages(e.target.value);
        });
    }

    async loadPages() {
        const loading = document.getElementById('pagesLoading');
        const container = document.getElementById('pagesContainer');
        
        try {
            loading.style.display = 'block';
            const response = await fetch('/api/v1/seo_pages_list');
            if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
            
            this.pages = await response.json();
            this.filteredPages = [...this.pages];
            this.renderPages();
            this.updateCount();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü:', error);
            container.innerHTML = '<div style="color: var(--danger-color); text-align: center; padding: 2rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü</div>';
        } finally {
            loading.style.display = 'none';
        }
    }

    filterPages(query) {
        if (!query.trim()) {
            this.filteredPages = [...this.pages];
        } else {
            const lowerQuery = query.toLowerCase();
            this.filteredPages = this.pages.filter(page => 
                page.title.toLowerCase().includes(lowerQuery) ||
                page.slug.toLowerCase().includes(lowerQuery) ||
                page.main_keyword.toLowerCase().includes(lowerQuery) ||
                (page.meta_keywords && page.meta_keywords.some(keyword => 
                    keyword.toLowerCase().includes(lowerQuery)
                ))
            );
        }
        this.renderPages();
        this.updateCount();
    }

    renderPages() {
        const container = document.getElementById('pagesContainer');
        
        if (this.filteredPages.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <p>–°—Ç—Ä–∞–Ω–∏—Ü –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                    <a href="/admin/create-page" class="btn btn-primary" style="margin-top: 1rem;">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É</a>
                </div>
            `;
            return;
        }

        container.innerHTML = this.filteredPages.map(page => `
            <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #f8f9fa;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                    <div>
                        <h4 style="color: var(--primary-color); margin: 0 0 0.25rem 0;">
                            <a href="/${page.slug}" target="_blank" style="text-decoration: none; color: inherit;">${page.title}</a>
                        </h4>
                        <div style="font-size: 0.9rem; color: #666;">
                            <span>üîó <code>/${page.slug}</code></span>
                            <span style="margin-left: 1rem;">üéØ ${page.meta_keywords ? page.meta_keywords.length : 0} –∫–ª—é—á–µ–π</span>
                            <span style="margin-left: 1rem;">üìù ${page.main_keyword}</span>
                            ${page.product_info && page.product_info.product_name ? `
                                <span style="margin-left: 1rem;">üîß ${page.product_info.product_name}</span>
                            ` : ''}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; flex-shrink: 0;">
                        <a href="/${page.slug}" class="btn btn-sm btn-primary" target="_blank" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">üëÅÔ∏è</a>
                        <a href="/admin/edit-page/${page.slug}" class="btn btn-sm btn-warning" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</a>
                        <a href="/admin/prompts/${page.slug}" class="btn btn-sm" style="background-color: #9b59b6; color: white;" title="–ü—Ä–æ–º–ø—Ç—ã">ü§ñ</a>
                        <button class="btn btn-sm btn-danger" onclick="seoPagesList.confirmDelete('${page.slug}')" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                    </div>
                </div>
                
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">
                    ${page.meta_description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}
                </div>
                
                ${page.product_info && page.product_info.product_description ? `
                    <div style="font-size: 0.85rem; color: #495057; margin-bottom: 0.5rem; padding: 0.5rem; background: #e3f2fd; border-radius: 4px;">
                        <strong>–ü—Ä–æ–¥—É–∫—Ç:</strong> ${page.product_info.product_description}
                    </div>
                ` : ''}
                
                ${page.meta_keywords && page.meta_keywords.length > 0 ? `
                    <div style="font-size: 0.8rem;">
                        <strong>–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:</strong> 
                        ${page.meta_keywords.slice(0, 5).map(keyword => 
                            `<span style="background: #e9ecef; padding: 0.2rem 0.4rem; border-radius: 3px; margin-right: 0.3rem;">${keyword}</span>`
                        ).join('')}
                        ${page.meta_keywords.length > 5 ? `<span style="color: #666;">+${page.meta_keywords.length - 5} –µ—â–µ</span>` : ''}
                    </div>
                ` : ''}
            </div>
        `).join('');
    }

    updateCount() {
        document.getElementById('pagesCount').textContent = this.filteredPages.length;
    }

    async confirmDelete(slug) {
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É "${slug}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/v1/delete_page/${slug}`, {
                method: 'DELETE'
            });

            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã');

            this.showAlert('–°—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞', 'success');
            await this.loadPages();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã:', error);
            this.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É', 'error');
        }
    }

    showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;
        
        document.querySelector('.main-container').insertBefore(alertDiv, document.querySelector('.main-container').firstChild);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
}

function refreshPages() {
    seoPagesList.loadPages();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
let seoPagesList;
document.addEventListener('DOMContentLoaded', () => {
    seoPagesList = new SeoPagesList();
});
</script>
{% endblock %}
