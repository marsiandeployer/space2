{% extends "admin/base.html" %}

{% block title %}–°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É - B2B SEO-Platform Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h2>–°–æ–∑–¥–∞–Ω–∏–µ SEO-—Å—Ç—Ä–∞–Ω–∏—Ü—ã</h2>
    <div class="breadcrumb">
        <a href="/admin">–î–∞—à–±–æ—Ä–¥</a> / <a href="/admin/seo-pages">SEO-—Å—Ç—Ä–∞–Ω–∏—Ü—ã</a> / –°–æ–∑–¥–∞—Ç—å
    </div>
</div>

<div class="card">
    <h3>‚ûï –ù–æ–≤–∞—è SEO-—Å—Ç—Ä–∞–Ω–∏—Ü–∞</h3>
    
    <form id="createPageForm">
        <div class="form-group">
            <label for="productSelect">–ü—Ä–æ–¥—É–∫—Ç/–°–µ—Ä–≤–∏—Å:</label>
            <select id="productSelect" name="product_id" required>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç...</option>
                <!-- –ü—Ä–æ–¥—É–∫—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </select>
            <small style="color: #666;">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç –¥–ª—è —Å–≤—è–∑–∏ —Å SEO-—Å—Ç—Ä–∞–Ω–∏—Ü–µ–π</small>
        </div>

        <div class="form-group">
            <label for="keyword">–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ:</label>
            <input type="text" id="keyword" name="keyword" required 
                   placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∞–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞ –ø–æ—Å—Ç–∞–≤–∫–∏"
                   value="{{ request.args.get('keyword', '') }}">
            <small style="color: #666;">–û—Å–Ω–æ–≤–Ω–æ–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</small>
        </div>

        <div class="form-group">
            <label for="pageTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:</label>
            <input type="text" id="pageTitle" name="title" required 
                   placeholder="–ë—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏">
            <small style="color: #666;">–ó–∞–≥–æ–ª–æ–≤–æ–∫ SEO-—Å—Ç—Ä–∞–Ω–∏—Ü—ã (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞)</small>
        </div>

        <div class="form-group">
            <label for="metaDescription">–ú–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏–µ:</label>
            <textarea id="metaDescription" name="meta_description" rows="3" 
                      placeholder="–ë—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞"></textarea>
            <small style="color: #666;">–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)</small>
        </div>

        <div class="form-group">
            <label for="model">–ú–æ–¥–µ–ª—å LLM:</label>
            <select id="model" name="model">
                <option value="deepseek">DeepSeek (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</option>
                <option value="openai">OpenAI</option>
            </select>
            <small style="color: #666;">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</small>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" id="skipExisting" name="skipExisting" checked>
                –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å, –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            </label>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
            <button type="submit" class="btn btn-success">üöÄ –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
            <a href="/admin/seo-pages" class="btn btn-secondary">‚ùå –û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>

    <div id="creationProgress" style="display: none; margin-top: 2rem;">
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
            <h4>–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã...</h4>
            <div class="loading">
                <div class="spinner"></div>
                <div id="progressText">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
            </div>
        </div>
    </div>

    <div id="creationResult" style="display: none; margin-top: 2rem;">
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
    </div>
</div>

<!-- –ë—ã—Å—Ç—Ä—ã–µ —à–∞–±–ª–æ–Ω—ã -->
<div class="card">
    <h3>üéØ –ë—ã—Å—Ç—Ä—ã–µ —à–∞–±–ª–æ–Ω—ã</h3>
    <p>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ç–æ–≤—ã–π —à–∞–±–ª–æ–Ω –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã:</p>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
        <div style="border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; background: #f8f9fa;">
            <h4>–î–æ–≥–æ–≤–æ—Ä—ã –∞—Ä–µ–Ω–¥—ã</h4>
            <p style="font-size: 0.9rem; color: #666;">–ê–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –∞—Ä–µ–Ω–¥—ã –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</p>
            <button class="btn btn-sm btn-primary" onclick="useTemplate('–∞–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞ –∞—Ä–µ–Ω–¥—ã')">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
        </div>
        
        <div style="border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; background: #f8f9fa;">
            <h4>–î–æ–≥–æ–≤–æ—Ä—ã –ø–æ—Å—Ç–∞–≤–∫–∏</h4>
            <p style="font-size: 0.9rem; color: #666;">–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –ø–æ—Å—Ç–∞–≤–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</p>
            <button class="btn btn-sm btn-primary" onclick="useTemplate('–ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ –ø–æ—Å—Ç–∞–≤–∫–∏')">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
        </div>
        
        <div style="border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; background: #f8f9fa;">
            <h4>–¢—Ä—É–¥–æ–≤—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ã</h4>
            <p style="font-size: 0.9rem; color: #666;">–≠–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ —Ç—Ä—É–¥–æ–≤—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤</p>
            <button class="btn btn-sm btn-primary" onclick="useTemplate('—ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ —Ç—Ä—É–¥–æ–≤–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞')">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
        </div>
        
        <div style="border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; background: #f8f9fa;">
            <h4>IT-–¥–æ–≥–æ–≤–æ—Ä—ã</h4>
            <p style="font-size: 0.9rem; color: #666;">–ê–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ IT-—É—Å–ª—É–≥</p>
            <button class="btn btn-sm btn-primary" onclick="useTemplate('–∞–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞ IT-—É—Å–ª—É–≥')">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
        </div>
        
        <div style="border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; background: #f8f9fa;">
            <h4>–î–æ–≥–æ–≤–æ—Ä—ã –ø–æ–¥—Ä—è–¥–∞</h4>
            <p style="font-size: 0.9rem; color: #666;">–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –ø–æ–¥—Ä—è–¥–∞</p>
            <button class="btn btn-sm btn-primary" onclick="useTemplate('–ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ –ø–æ–¥—Ä—è–¥–∞')">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
        </div>
        
        <div style="border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; background: #f8f9fa;">
            <h4>–ö—Ä–µ–¥–∏—Ç–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ã</h4>
            <p style="font-size: 0.9rem; color: #666;">–ê–Ω–∞–ª–∏–∑ –∫—Ä–µ–¥–∏—Ç–Ω—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤</p>
            <button class="btn btn-sm btn-primary" onclick="useTemplate('–∞–Ω–∞–ª–∏–∑ –∫—Ä–µ–¥–∏—Ç–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞')">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class CreatePageForm {
    constructor() {
        this.init();
    }

    async init() {
        await this.loadProducts();
        this.setupEventListeners();
    }

    async loadProducts() {
        try {
            const response = await fetch('/api/v1/products');
            if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã');
            
            const products = await response.json();
            const select = document.getElementById('productSelect');
            
            // –û—á–∏—â–∞–µ–º –æ–ø—Ü–∏–∏ –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç...</option>';
            
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.product_id;
                option.textContent = product.name;
                option.dataset.description = product.description;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', error);
            this.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤', 'error');
        }
    }

    setupEventListeners() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–¥—É–∫—Ç–∞
        document.getElementById('productSelect').addEventListener('change', (e) => {
            this.onProductChange(e.target.value);
        });
        
        // –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞
        document.getElementById('keyword').addEventListener('input', (e) => {
            this.generateTitle(e.target.value);
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
        document.getElementById('createPageForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleSubmit();
        });
    }

    onProductChange(productId) {
        const select = document.getElementById('productSelect');
        const selectedOption = select.querySelector(`option[value="${productId}"]`);
        
        if (selectedOption && selectedOption.dataset.description) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–¥—É–∫—Ç–∞
            const keyword = document.getElementById('keyword').value;
            if (keyword) {
                this.generateMetaDescription(keyword, selectedOption.dataset.description);
            }
        }
    }

    generateTitle(keyword) {
        if (!keyword.trim()) return;
        
        const title = keyword.charAt(0).toUpperCase() + keyword.slice(1);
        document.getElementById('pageTitle').value = title;
        
        // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏–µ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –ø—Ä–æ–¥—É–∫—Ç
        const productSelect = document.getElementById('productSelect');
        const selectedOption = productSelect.querySelector(`option[value="${productSelect.value}"]`);
        if (selectedOption && selectedOption.dataset.description) {
            this.generateMetaDescription(keyword, selectedOption.dataset.description);
        }
    }

    generateMetaDescription(keyword, productDescription) {
        const metaDescription = `${keyword} - ${productDescription}. –ë—ã—Å—Ç—Ä–æ, –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ, –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ.`;
        document.getElementById('metaDescription').value = metaDescription;
    }

    async handleSubmit() {
        const formData = new FormData(document.getElementById('createPageForm'));
        const data = {
            product_id: formData.get('product_id'),
            keyword: formData.get('keyword').trim(),
            title: formData.get('title').trim(),
            meta_description: formData.get('meta_description').trim(),
            model: formData.get('model'),
            skipExisting: formData.has('skipExisting')
        };

        if (!data.product_id) {
            this.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç', 'error');
            return;
        }

        if (!data.keyword) {
            this.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ', 'error');
            return;
        }

        if (!data.title) {
            this.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã', 'error');
            return;
        }

        try {
            this.showProgress(true, '–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã...');
            this.hideResult();

            // –°–æ–∑–¥–∞–µ–º slug –∏–∑ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞
            const slug = data.keyword.toLowerCase()
                .replace(/[^–∞-—è—ë\w\s]/gi, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-+|-+$/g, '');

            const response = await fetch('/api/v1/create_page_with_product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    slug: slug,
                    title: data.title,
                    keywords: [data.keyword],
                    product_id: data.product_id,
                    meta_description: data.meta_description
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
            }

            const result = await response.json();
            this.showResult(result, data.keyword);
            this.showAlert('–°—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!', 'success');
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('keyword').value = '';
            document.getElementById('pageTitle').value = '';
            document.getElementById('metaDescription').value = '';
            document.getElementById('productSelect').value = '';
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã:', error);
            this.showAlert(error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É', 'error');
        } finally {
            this.showProgress(false);
        }
    }

    showProgress(show, text = '') {
        const progressDiv = document.getElementById('creationProgress');
        const progressText = document.getElementById('progressText');
        
        progressDiv.style.display = show ? 'block' : 'none';
        if (text) progressText.textContent = text;
    }

    showResult(result, keyword) {
        const resultDiv = document.getElementById('creationResult');
        resultDiv.style.display = 'block';
        
        resultDiv.innerHTML = `
            <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 1rem; border-radius: 8px;">
                <h4 style="color: #155724; margin: 0 0 1rem 0;">‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!</h4>
                <div style="margin-bottom: 1rem;">
                    <strong>–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ:</strong> ${keyword}<br>
                    <strong>–°–ª–∞–≥:</strong> <code>${result.slug || 'generating...'}</code><br>
                    <strong>URL:</strong> <a href="/${result.slug || ''}" target="_blank">/${result.slug || ''}</a>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <a href="/${result.slug || ''}" class="btn btn-primary" target="_blank">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å</a>
                    <a href="/admin/edit-page/${result.slug || ''}" class="btn btn-warning">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                    <a href="/admin/seo-pages" class="btn btn-secondary">üìÑ –ö —Å–ø–∏—Å–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü</a>
                </div>
            </div>
        `;
    }

    hideResult() {
        document.getElementById('creationResult').style.display = 'none';
    }

    showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;
        
        document.querySelector('.main-container').insertBefore(alertDiv, document.querySelector('.main-container').firstChild);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
}

function useTemplate(keyword) {
    document.getElementById('keyword').value = keyword;
    document.getElementById('keyword').focus();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', () => {
    new CreatePageForm();
});
</script>
{% endblock %}
